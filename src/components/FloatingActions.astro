---
import type { Language } from '@/i18n/config'
import LanguageSwitcherIcon from '@/assets/icons/language-switcher.svg'
import ThemeToggleIcon from '@/assets/icons/theme-toggle.svg'
import { moreLocales, themeConfig } from '@/config'
import { getLangFromPath, getNextGlobalLang } from '@/i18n/lang'
import {
  getLocalizedPath,
  getNextGlobalLangPath,
  getNextSupportedLangPath,
} from '@/i18n/path'
import { isPostPage } from '@/utils/page'

interface Props {
  supportedLangs: Language[]
}

const {
  light: { background: lightMode },
  dark: { background: darkMode },
} = themeConfig.color

const { supportedLangs } = Astro.props
const currentPath = Astro.url.pathname

const showLanguageSwitcher = moreLocales.length > 0
const nextUrl
  = supportedLangs.length > 0
    ? getNextSupportedLangPath(currentPath, supportedLangs)
  : getNextGlobalLangPath(currentPath)
const isPost = isPostPage(currentPath)
const currentLang = getLangFromPath(currentPath)
const nextLang = getNextGlobalLang(currentLang)
const fallbackUrl = getLocalizedPath('/', nextLang)
const isSingleLangPost = isPost && supportedLangs.length <= 1
const targetUrl = isSingleLangPost ? fallbackUrl : nextUrl
---

<div
  class:list={[
    'absolute right-7.25vw top-14.6 flex gap-6 min-[823px]:max-lg:right-[calc(50vw-22rem)]',
    'lg:(fixed bottom-[min(10.27rem+1.92vw,12rem)] right-[max(5rem,calc(50vw-35rem))] top-auto w-14rem)',
  ]}
>
  {
    showLanguageSwitcher && (
      <a
        id="language-switcher"
        href={targetUrl}
        data-next-lang={nextLang}
        class="aspect-square w-4 c-secondary active:scale-90 hover:c-primary"
        aria-label="Switch website language"
      >
        <LanguageSwitcherIcon aria-hidden="true" fill="currentColor" />
      </a>
    )
  }

  <button
    id="theme-toggle-button"
    class="aspect-square w-4 c-secondary active:scale-90 hover:c-primary"
    aria-label="Switch light/dark theme"
  >
    <ThemeToggleIcon aria-hidden="true" fill="currentColor" />
  </button>
</div>

<script is:inline>
  document.addEventListener('click', (e) => {
    const target = e.target instanceof Element ? e.target : null
    const link = target ? target.closest('#language-switcher') : null
    if (!link) {
      return
    }

    e.preventDefault()
    const url = link.getAttribute('href')
    const nextLang = link.getAttribute('data-next-lang')
    if (nextLang) {
      try {
        localStorage.setItem('lang', nextLang)
      }
      catch {}
    }
    if (url) {
      location.replace(url)
    }
  })
</script>

<script
  is:inline
  define:vars={{
    lightMode,
    darkMode,
  }}
>
  function applyTheme(isDark) {
    document.documentElement.classList.toggle('dark', isDark)

    const metaThemeColor = document.head.querySelector('meta[name="theme-color"]')
    if (metaThemeColor && lightMode && darkMode) {
      metaThemeColor.setAttribute('content', isDark ? darkMode : lightMode)
    }

    localStorage.setItem('theme', isDark ? 'dark' : 'light')
    document.dispatchEvent(new Event('theme-changed'))
  }

  function toggleTheme() {
    const isDark = !document.documentElement.classList.contains('dark')
    applyTheme(isDark)
  }

  function handleThemeToggleClick(e) {
    const target = e.target instanceof Element ? e.target : null
    const button = target?.closest('#theme-toggle-button')

    if (!button) {
      return
    }

    if (document.documentElement.classList.contains('reduce-motion')) {
      toggleTheme()
      return
    }

    document.documentElement.style.setProperty('view-transition-name', 'animation-theme-toggle')
    document.documentElement.setAttribute('data-theme-changing', '')

    const transition = document.startViewTransition(toggleTheme)

    transition.finished.then(() => {
      document.documentElement.style.removeProperty('view-transition-name')
      document.documentElement.removeAttribute('data-theme-changing')
    })
  }

  document.addEventListener('click', handleThemeToggleClick, { passive: true })

  window
    .matchMedia('(prefers-color-scheme: dark)')
    .addEventListener('change', (event) => {
      const isDark = event.matches
      applyTheme(isDark)
    })
</script>

